stages:
  - lint
  - sast
  - dependency
  - test
  - report

# -----------------------------
# PHPCS with Moodle Coding Standard
# -----------------------------
# -----------------------------
# PHPCS with Moodle Coding Standard
# -----------------------------
phpcs_moodle:
  stage: lint
  image: "php:${PHP_VERSION}-cli"

  script:
    # Base tools
    - apt-get update && apt-get install -y git unzip curl

    # Composer
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

    # Composer configuration (required for Moodle CS)
    - composer global config minimum-stability dev
    - composer global config prefer-stable true
    - composer global config --no-plugins allow-plugins.dealerdirect/phpcodesniffer-composer-installer true

    # Install PHPCS stack (Moodle-compatible)
    - composer global require
        squizlabs/php_codesniffer:^3
        moodlehq/moodle-cs
        phpcompatibility/php-compatibility
        phpcsstandards/phpcsextra
        phpcsstandards/phpcsutils

    # Make global binaries available
    - export PATH="$PATH:$HOME/.composer/vendor/bin"

    # Optional sanity check (can be removed later)
    - phpcs -i

    # Run PHPCS
    # - PHPCS 3 + PHP 8.3 requires deprecation suppression
    - >
      php -d error_reporting='E_ALL & ~E_DEPRECATED & ~E_USER_DEPRECATED'
      $(which phpcs)
      --standard=Moodle
      --report-full
      --report-checkstyle=phpcs.xml
      --ignore=*/vendor/*
      "$PLUGIN_PATH"
      || echo "PHPCS failed" > phpcs_failed.txt

  artifacts:
    when: always
    paths:
      - "$CI_PROJECT_DIR/phpcs.xml"
      - "$CI_PROJECT_DIR/phpcs_failed.txt"
    expire_in: 1 week

  allow_failure: true

# -----------------------------
# Semgrep SAST
# -----------------------------
semgrep_sast:
  stage: sast
  image: returntocorp/semgrep:latest
  script:
    - semgrep --config=auto --severity=ERROR --error --json --output=semgrep-error.json "$PLUGIN_PATH" || echo "Semgrep failed" > semgrep_failed.txt
    - semgrep --config=auto --severity=ERROR --text "$PLUGIN_PATH" || true
  artifacts:
    when: always
    paths:
      - "$CI_PROJECT_DIR/semgrep-error.json"
      - "$CI_PROJECT_DIR/semgrep_failed.txt"
    expire_in: 1 week
  allow_failure: true

# -----------------------------
# Trivy Vulnerability, Secrets & Misconfig Scan
# -----------------------------
trivy_scan:
  stage: dependency
  image: aquasec/trivy:latest
  script:
    - trivy fs --scanners vuln,secret,misconfig --severity HIGH,CRITICAL --exit-code 1 --format table "$PLUGIN_PATH" || true
    - trivy fs --scanners vuln,secret,misconfig --severity HIGH,CRITICAL --exit-code 1 --format json --output trivy-report.json "$PLUGIN_PATH" || echo "Trivy failed" > trivy_failed.txt
  artifacts:
    when: always
    paths:
      - "$CI_PROJECT_DIR/trivy-report.json"
      - "$CI_PROJECT_DIR/trivy_failed.txt"
    expire_in: 1 week
  allow_failure: true

# -----------------------------
# PHPStan with Moodle Extension
# -----------------------------
phpstan_moodle:
  stage: lint
  image: "php:${PHP_VERSION}-cli"
  script:
    - apt-get update && apt-get install -y git unzip curl libzip-dev libpng-dev libicu-dev
    - docker-php-ext-install zip gd intl
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - cd /builds/$CI_PROJECT_PATH
    - composer require --dev phpstan/phpstan:^2.1 micaherne/phpstan-moodle
    - git clone --branch "$MOODLE_BRANCH" --depth=1 https://github.com/moodle/moodle.git /tmp/moodle
    # IMPORTANT CHANGE: do NOT require phpunit here (not needed, and conflicts on 5.0)
    - cd /tmp/moodle && composer install --ignore-platform-reqs && cp config-dist.php config.php && cd -
    - mkdir -p "/tmp/moodle/$(dirname "$PLUGIN_PATH")"
    - ln -s "/builds/$CI_PROJECT_PATH/$PLUGIN_PATH" "/tmp/moodle/$PLUGIN_PATH"
    - |
      cat << EOF > /builds/$CI_PROJECT_PATH/phpstan.neon
      includes:
        - vendor/micaherne/phpstan-moodle/extension.neon

      parameters:
        moodle:
          rootDirectory: /tmp/moodle
        paths:
          - /tmp/moodle/$PLUGIN_PATH
        excludePaths:
          - */vendor/*
        phpVersion: ${PHPSTAN_VERSION}
        level: 5
        reportUnmatchedIgnoredErrors: false
        ignoreErrors:
          - '#Call to an undefined method#'
          - '#Access to an undefined property#'
          - '#Undefined variable: \\\$DB#'
          - '#Undefined variable: \\\$CFG#'
      EOF
    - /builds/$CI_PROJECT_PATH/vendor/bin/phpstan analyse --memory-limit=1G --configuration=/builds/$CI_PROJECT_PATH/phpstan.neon || echo "PHPStan failed" > phpstan_failed.txt
    - /builds/$CI_PROJECT_PATH/vendor/bin/phpstan analyse --no-progress --error-format=json --memory-limit=1G --configuration=/builds/$CI_PROJECT_PATH/phpstan.neon > phpstan.json || true
  artifacts:
    when: always
    paths:
      - "$CI_PROJECT_DIR/phpstan.neon"
      - "$CI_PROJECT_DIR/phpstan_failed.txt"
      - "$CI_PROJECT_DIR/phpstan.json"
    expire_in: 1 week
  allow_failure: true

# -----------------------------
# PHPUnit Testing with Moodle
# -----------------------------
phpunit_moodle:
  stage: test
  image: "php:${PHP_VERSION}-cli-bookworm"
  services:
    - name: "postgres:${POSTGRES_VERSION}"

  variables:
    POSTGRES_DB: "moodle"
    POSTGRES_USER: "moodle"
    POSTGRES_PASSWORD: "moodle"
    DB_HOST: "postgres"

  coverage: '/PHPUNIT_COVERAGE:\s+([0-9.]+)%/'
  allow_failure: true

  script:
    - |
      set +e  # Don't exit on errors, we want to create artifacts even if tests fail
      
      # Ensure artifact files exist at the end
      trap 'touch "$CI_PROJECT_DIR"/{junit.xml,coverage.xml,coverage.txt,coverage_percent.txt,plugin_coverage_output.txt}' EXIT
      
      # ---------------------------
      # System dependencies + locales
      # ---------------------------
      apt-get update
      apt-get install -y git unzip curl locales libzip-dev libpng-dev libicu-dev libpq-dev libmagickwand-dev libc-client-dev libkrb5-dev

      # Required locales for Moodle PHPUnit
      sed -i '/en_AU.UTF-8/s/^# //g' /etc/locale.gen || echo "en_AU.UTF-8 UTF-8" >> /etc/locale.gen
      sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen || echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
      locale-gen
      update-locale LANG=en_AU.UTF-8

      # ---------------------------
      # PHP extensions
      # ---------------------------
      docker-php-ext-install zip gd intl pgsql pdo_pgsql
      docker-php-ext-configure imap --with-kerberos --with-imap-ssl
      docker-php-ext-install imap

      pecl install imagick xdebug
      docker-php-ext-enable imagick xdebug

      cat > /usr/local/etc/php/conf.d/xdebug.ini <<'INI'
      xdebug.mode=coverage
      xdebug.start_with_request=yes
      INI

      cat > /usr/local/etc/php/conf.d/zz-moodle.ini <<'INI'
      memory_limit=512M
      max_input_vars=5000
      max_execution_time=300
      INI

      # ---------------------------
      # Composer
      # ---------------------------
      curl -sS https://getcomposer.org/installer \
        | php -- --install-dir=/usr/local/bin --filename=composer

      # ---------------------------
      # Moodle core
      # ---------------------------
      git clone --branch "$MOODLE_BRANCH" --depth=1 https://github.com/moodle/moodle.git /tmp/moodle

      cd /tmp/moodle
      # Let Moodle's composer.lock decide the phpunit version (9 on 4.x, 11 on 5.x, ...)
      composer install --ignore-platform-reqs
      cd -

      # ---------------------------
      # Data roots
      # ---------------------------
      mkdir -p /tmp/moodledata /tmp/moodledata_phpunit
      chmod 777 /tmp/moodledata /tmp/moodledata_phpunit

      # ---------------------------
      # config.php (complete DB cfg)
      # ---------------------------
      cat > /tmp/moodle/config.php <<'PHP'
      <?php
      unset($CFG); global $CFG; $CFG = new stdClass();
      $CFG->dbtype    = 'pgsql';
      $CFG->dblibrary = 'native';
      $CFG->dbhost    = getenv('DB_HOST');
      $CFG->dbname    = getenv('POSTGRES_DB');
      $CFG->dbuser    = getenv('POSTGRES_USER');
      $CFG->dbpass    = getenv('POSTGRES_PASSWORD');
      $CFG->prefix    = 'mdl_';
      $CFG->dboptions = ['dbpersist'=>0,'dbport'=>'','dbsocket'=>''];
      $CFG->wwwroot   = 'http://localhost';
      $CFG->dataroot  = '/tmp/moodledata';
      $CFG->phpunit_prefix   = 'phpu_';
      $CFG->phpunit_dataroot = '/tmp/moodledata_phpunit';
      $CFG->directorypermissions = 0777;
      require_once(__DIR__ . '/lib/setup.php');
      PHP

      # ---------------------------
      # Symlink plugin
      # ---------------------------
      mkdir -p "/tmp/moodle/$(dirname "$PLUGIN_PATH")"
      ln -s "$CI_PROJECT_DIR/$PLUGIN_PATH" "/tmp/moodle/$PLUGIN_PATH"

      # ---------------------------
      # Install DB + init PHPUnit
      # ---------------------------
      php /tmp/moodle/admin/cli/install_database.php --agree-license --adminpass=Pass123!
      php /tmp/moodle/admin/tool/phpunit/cli/init.php

      # ---------------------------
      # Run PHPUnit with coverage
      # ---------------------------
      cd /tmp/moodle

      vendor/bin/phpunit \
        --testsuite "${PLUGIN_NAME}_testsuite" \
        --coverage-text=/tmp/moodle/coverage.txt \
        --coverage-clover=/tmp/moodle/coverage.xml \
        --log-junit=/tmp/moodle/junit.xml \
        --testdox || true

      # Copy reports into project dir (create empty files if they don't exist)
      cp /tmp/moodle/junit.xml    "$CI_PROJECT_DIR/junit.xml" 2>/dev/null || touch "$CI_PROJECT_DIR/junit.xml"
      cp /tmp/moodle/coverage.xml "$CI_PROJECT_DIR/coverage.xml" 2>/dev/null || touch "$CI_PROJECT_DIR/coverage.xml"
      cp /tmp/moodle/coverage.txt "$CI_PROJECT_DIR/coverage.txt" 2>/dev/null || touch "$CI_PROJECT_DIR/coverage.txt"
      
      # Verify files were created
      echo "Checking artifact files in $CI_PROJECT_DIR:"
      ls -lh "$CI_PROJECT_DIR"/*.xml "$CI_PROJECT_DIR"/*.txt 2>/dev/null || echo "Some artifact files missing"
      
      cd "$CI_PROJECT_DIR"

      # ---------------------------
      # Plugin-only coverage from coverage.xml via inline parser
      # (this is plugin_coverage.php generated on-the-fly)
      # ---------------------------

      cat > plugin_coverage.php <<'PHP'
      <?php
      /**
       * Plugin-only coverage parser for PHPUnit Clover XML.
       *
       * Usage inside CI:
       *   php plugin_coverage.php coverage.xml "$PLUGIN_NAME" "$PLUGIN_PATH"
       */
      if ($argc < 3) {
          fwrite(STDERR, "Usage: php {$argv[0]} coverage.xml PLUGIN_NAMESPACE [PLUGIN_PATH]\n");
          exit(1);
      }

      $xmlFile         = $argv[1];
      $pluginNamespace = rtrim($argv[2], '\\'); // e.g. "auth_eledia_support"
      $pluginPath      = $argv[3] ?? null;      // e.g. "auth/eledia_support"

      if (!file_exists($xmlFile)) {
          fwrite(STDERR, "coverage.xml not found: {$xmlFile}\n");
          echo "PHPUNIT_COVERAGE: 0.00%\n";
          exit(0);
      }

      $xml = simplexml_load_file($xmlFile);
      if ($xml === false || !isset($xml->project)) {
          fwrite(STDERR, "Invalid coverage.xml (no <project> node).\n");
          echo "PHPUNIT_COVERAGE: 0.00%\n";
          exit(0);
      }

      // Structure: <coverage><project><package><file><class>...
      $files = $xml->project->xpath('.//file');
      if (!$files) {
          fwrite(STDERR, "No <file> nodes found under <project>.\n");
          echo "PHPUNIT_COVERAGE: 0.00%\n";
          exit(0);
      }

      $prefixNoSlash  = $pluginNamespace . '\\';
      $prefixWithLead = '\\' . $pluginNamespace . '\\';

      $totalStatements = 0;
      $totalCovered    = 0;
      $rows            = [];

      foreach ($files as $file) {
          $fileName = (string)$file['name'];

          // Optional plugin-path filter: "auth/eledia_support"
          if ($pluginPath && strpos($fileName, '/' . $pluginPath . '/') === false) {
              continue;
          }

          foreach ($file->class as $class) {
              $className = (string)$class['name'];

              $isInNamespace =
                  strpos($className, $prefixNoSlash) === 0 ||
                  strpos($className, $prefixWithLead) === 0 ||
                  $className === $pluginNamespace;

              if (!$isInNamespace) {
                  continue;
              }

              $metrics = $class->metrics;
              if (!$metrics) {
                  continue;
              }

              $stmts       = isset($metrics['statements'])        ? (int)$metrics['statements']        : 0;
              $coveredStmt = isset($metrics['coveredstatements']) ? (int)$metrics['coveredstatements'] : 0;
              $methods     = isset($metrics['methods'])           ? (int)$metrics['methods']           : 0;
              $coveredMeth = isset($metrics['coveredmethods'])    ? (int)$metrics['coveredmethods']    : 0;

              $totalStatements += $stmts;
              $totalCovered    += $coveredStmt;

              $linePct   = $stmts   > 0 ? ($coveredStmt * 100.0 / $stmts)   : 0.0;
              $methodPct = $methods > 0 ? ($coveredMeth * 100.0 / $methods) : 0.0;

              $rows[] = [
                  'class'       => $className,
                  'methods'     => $methods,
                  'coveredMeth' => $coveredMeth,
                  'stmts'       => $stmts,
                  'coveredStmt' => $coveredStmt,
                  'linePct'     => $linePct,
                  'methodPct'   => $methodPct,
              ];
          }
      }

      echo "======================================================\n";
      echo "PLUGIN COVERAGE (classes in namespace: {$pluginNamespace})\n";
      echo "======================================================\n";

      if (empty($rows)) {
          echo "No plugin classes found in coverage.xml\n";
          echo "PHPUNIT_COVERAGE: 0.00%\n";
          $outputDir = getenv('CI_PROJECT_DIR') ?: __DIR__;
          file_put_contents($outputDir . '/coverage_percent.txt', "0.00\n");
          exit(0);
      }

      foreach ($rows as $row) {
          printf(
              "%s\n  Methods: %7.2f%% (%3d/%3d)   Lines: %7.2f%% (%4d/%4d)\n",
              $row['class'],
              $row['methodPct'],
              $row['coveredMeth'],
              $row['methods'],
              $row['linePct'],
              $row['coveredStmt'],
              $row['stmts']
          );
      }

      echo "------------------------------------------------------\n";

      if ($totalStatements > 0) {
          $overallPct = $totalCovered * 100.0 / $totalStatements;
      } else {
          $overallPct = 0.0;
      }

      $overallStr = sprintf('%.2f', $overallPct);
      printf("OVERALL PLUGIN LINE COVERAGE: %s%%\n", $overallStr);
      printf("PHPUNIT_COVERAGE: %s%%\n", $overallStr);
      
      // Write to CI_PROJECT_DIR instead of __DIR__
      $outputDir = getenv('CI_PROJECT_DIR') ?: __DIR__;
      file_put_contents($outputDir . '/coverage_percent.txt', $overallStr . "\n");
      PHP

      echo ""
      echo "PLUGIN COVERAGE AGGREGATE (via plugin_coverage.php):"
      cd "$CI_PROJECT_DIR"
      php plugin_coverage.php coverage.xml "$PLUGIN_NAME" "$PLUGIN_PATH" | tee plugin_coverage_output.txt || touch plugin_coverage_output.txt coverage_percent.txt
      
      # Final verification of all artifacts before job ends
      echo "Final artifact check:"
      ls -lh junit.xml coverage.xml coverage.txt coverage_percent.txt plugin_coverage_output.txt 2>&1 || echo "Some files may be missing, but will be created by trap"
      
      exit 0  # Always exit successfully to ensure artifacts are uploaded

  artifacts:
    when: always
    paths:
      - junit.xml
      - coverage.xml
      - coverage.txt
      - coverage_percent.txt
      - plugin_coverage_output.txt
    expire_in: 1 week

# -----------------------------
# Behat Acceptance Testing
# -----------------------------
behat_moodle:
  stage: test
  image: php:${PHP_VERSION}-cli-bookworm
  services:
    - name: postgres:${POSTGRES_VERSION}
    - name: selenium/standalone-firefox:${SELENIUM_VERSION}

  variables:
    POSTGRES_DB: moodle
    POSTGRES_USER: moodle
    POSTGRES_PASSWORD: moodle
    DB_HOST: postgres

  script:
    # PHP extensions
    - apt-get update && apt-get install -y git unzip curl libzip-dev libpng-dev libicu-dev libpq-dev locales libmagickwand-dev libc-client-dev libkrb5-dev
    - docker-php-ext-install zip gd intl pgsql pdo_pgsql
    - docker-php-ext-configure imap --with-kerberos --with-imap-ssl
    - docker-php-ext-install imap
    - pecl install imagick
    - docker-php-ext-enable imagick

    # PHP config
    - |
      cat > /usr/local/etc/php/conf.d/zz-moodle.ini <<'INI'
      max_input_vars = 5000
      memory_limit = 512M
      max_execution_time = 300
      INI

    # Composer
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

    # Moodle code
    - git clone --branch $MOODLE_BRANCH --depth=1 https://github.com/moodle/moodle.git /tmp/moodle
    - cd /tmp/moodle && composer install --no-dev --ignore-platform-reqs && composer require --dev behat/mink behat/behat && cd -

    # Data roots
    - mkdir -p /tmp/moodledata /tmp/moodledata_behat
    - chmod 777 /tmp/moodledata /tmp/moodledata_behat

    # Locales
    - sed -i '/en_AU.UTF-8/s/^# //g' /etc/locale.gen
    - sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen
    - locale-gen
    - update-locale LANG=en_AU.UTF-8

    # config.php
    - |
      cat > /tmp/moodle/config.php <<PHP
      <?php
      unset(\$CFG); global \$CFG; \$CFG = new stdClass();
      \$CFG->dbtype = 'pgsql';
      \$CFG->dblibrary = 'native';
      \$CFG->dbhost = getenv('DB_HOST');
      \$CFG->dbname = getenv('POSTGRES_DB');
      \$CFG->dbuser = getenv('POSTGRES_USER');
      \$CFG->dbpass = getenv('POSTGRES_PASSWORD');
      \$CFG->prefix = 'mdl_';
      \$CFG->wwwroot = 'http://localhost';
      \$CFG->dataroot = '/tmp/moodledata';
      \$CFG->behat_wwwroot = 'http://localhost:8000';
      \$CFG->behat_dataroot = '/tmp/moodledata_behat';
      \$CFG->behat_prefix = 'bht_';
      \$CFG->behat_dbname = 'behat_moodle';
      \$CFG->directorypermissions = 0777;
      require_once(__DIR__.'/lib/setup.php');
      PHP

    # Plugin symlink
    - mkdir -p "/tmp/moodle/$(dirname "$PLUGIN_PATH")"
    - ln -s "/builds/$CI_PROJECT_PATH/$PLUGIN_PATH" "/tmp/moodle/$PLUGIN_PATH"

    # Ensure Behat DB exists
    - apt-get install -y postgresql-client
    - PGPASSWORD=$POSTGRES_PASSWORD psql -h $DB_HOST -U $POSTGRES_USER -c "CREATE DATABASE behat_moodle;" || true

    # Init Behat
    - php /tmp/moodle/admin/tool/behat/cli/init.php || echo "Behat init failed" > behat_notice.txt
    
    # Start web server
    - php -S 0.0.0.0:8000 -t /tmp/moodle >/tmp/moodle/behat_webserver.log 2>&1 &
    - sleep 5

    # Run tests
    - cd /tmp/moodle
    - |
      if [ -d "/tmp/moodle/$PLUGIN_PATH/tests/behat" ]; then
        EXCLUDE_TAGS=$(grep -rhoE '@[A-Za-z0-9_]+' "/tmp/moodle/$PLUGIN_PATH/tests/behat" | grep '_wp$' | sort -u | tr '\n' ' ')
      else
        EXCLUDE_TAGS=""
      fi

      echo "Detected _wp tags: ${EXCLUDE_TAGS:-<none>}"

      TAG_EXPR=""
      for t in $EXCLUDE_TAGS; do
        if [ -z "$TAG_EXPR" ]; then TAG_EXPR="~$t"; else TAG_EXPR="$TAG_EXPR&&~$t"; fi
      done

      # Behat junit formatter creates a directory structure, so use /tmp first
      mkdir -p /tmp/behat-junit
      
      if [ -n "$TAG_EXPR" ]; then
        vendor/bin/behat \
          --config /tmp/moodledata_behat/behatrun/behat/behat.yml \
          --format pretty --out std \
          --format junit --out /tmp/behat-junit \
          --tags "$TAG_EXPR" \
          "/tmp/moodle/$PLUGIN_PATH/tests/behat" || true
      else
        vendor/bin/behat \
          --config /tmp/moodledata_behat/behatrun/behat/behat.yml \
          --format pretty --out std \
          --format junit --out /tmp/behat-junit \
          "/tmp/moodle/$PLUGIN_PATH/tests/behat" || true
      fi

      # Copy the entire behat-junit directory to CI_PROJECT_DIR
      cp -r /tmp/behat-junit "$CI_PROJECT_DIR/" || mkdir -p "$CI_PROJECT_DIR/behat-junit"
      : >> "$CI_PROJECT_DIR/behat_notice.txt"

  artifacts:
    when: always
    paths:
      - behat-junit/
      - behat_notice.txt
    expire_in: 1 week
  allow_failure: true

# -------------------
# Summary Report Stage
# -------------------
summary:
  stage: report
  image: alpine:3.19
  needs:
    - phpcs_moodle
    - phpstan_moodle
    - semgrep_sast
    - trivy_scan
    - phpunit_moodle
    - behat_moodle
  script:
    - apk add --no-cache jq coreutils grep sed libxml2-utils
    - echo "==================================================" > summary.md
    - echo "   ðŸ“ CI Security, Linting & Test Summary" >> summary.md
    - echo "==================================================" >> summary.md
    - echo "" >> summary.md
    - printf "%-10s | %-8s | %-25s | %-15s\n" "Tool" "Status" "Findings" "Report" >> summary.md
    - printf "%-10s-+-%-8s-+-%-25s-+-%-15s\n" "----------" "--------" "-------------------------" "---------------" >> summary.md

    # ---- PHPCS ----
    - |
      if [ -f phpcs.xml ]; then
        PHPCS_ERRORS=$(grep -c 'severity="error"' phpcs.xml || echo 0)
        PHPCS_WARNINGS=$(grep -c 'severity="warning"' phpcs.xml || echo 0)
        if [ "$PHPCS_ERRORS" -gt 0 ]; then PHPCS_FAIL=1; else PHPCS_FAIL=0; fi
        printf "%-10s | %-8s | %s errors, %s warnings | %s\n" \
          "PHPCS" "$( [ $PHPCS_FAIL -eq 0 ] && echo 'âœ… OK' || echo 'âŒ FAIL')" "$PHPCS_ERRORS" "$PHPCS_WARNINGS" "phpcs.xml" >> summary.md
        echo "--------------------------------------------------" >> summary.md
        echo "   ðŸ”Ž PHPCS (first 10 issues)" >> summary.md
        echo "--------------------------------------------------" >> summary.md
        grep -oP '<error line="[0-9]+" column="[0-9]+" severity="[^"]+" message="[^"]+"' phpcs.xml \
          | sed -E 's/<error line="([0-9]+)".*severity="([^"]+)".*message="([^"]+)".*/[Line \1] \U\2: \3/' \
          | head -n 10 >> summary.md || echo "No issues" >> summary.md
        echo "" >> summary.md
      else
        PHPCS_FAIL=0
        printf "%-10s | %-8s | %-25s | %-15s\n" "PHPCS" "âœ… OK" "0" "-" >> summary.md
      fi

    # ---- PHPStan ----
    - |
      if [ -f phpstan.json ]; then
        PHPSTAN_ERRORS=$(jq '.totals.file_errors' phpstan.json)
        if [ "$PHPSTAN_ERRORS" -gt 0 ]; then PHPSTAN_WARN=1; else PHPSTAN_WARN=0; fi
        printf "%-10s | %-8s | %s errors (advisory) | %s\n" \
          "PHPStan" "$( [ $PHPSTAN_WARN -eq 0 ] && echo 'â„¹ï¸ OK' || echo 'âš ï¸ WARN')" "$PHPSTAN_ERRORS" "phpstan.json" >> summary.md
        echo "--------------------------------------------------" >> summary.md
        echo "   ðŸ”Ž PHPStan (first 10 issues)" >> summary.md
        echo "--------------------------------------------------" >> summary.md
        jq -r '.files | to_entries[] | .key as $file | .value.messages[] | "[" + $file + ":" + (.line|tostring) + "] " + .message' phpstan.json \
          | head -n 10 >> summary.md || echo "No messages" >> summary.md
        echo "" >> summary.md
      else
        PHPSTAN_WARN=0
        printf "%-10s | %-8s | %-25s | %-15s\n" "PHPStan" "â„¹ï¸ OK" "0" "-" >> summary.md
      fi

    # ---- Semgrep ----
    - |
      if [ -f semgrep-error.json ]; then
        SEMGREP_FINDINGS=$(jq '.results | length' semgrep-error.json)
        if [ "$SEMGREP_FINDINGS" -gt 0 ]; then SEMGREP_FAIL=1; else SEMGREP_FAIL=0; fi
        printf "%-10s | %-8s | %s findings | %s\n" \
          "Semgrep" "$( [ $SEMGREP_FAIL -eq 0 ] && echo 'âœ… OK' || echo 'âŒ FAIL')" "$SEMGREP_FINDINGS" "semgrep-error.json" >> summary.md
        echo "--------------------------------------------------" >> summary.md
        echo "   ðŸ”Ž Semgrep (first 10 findings)" >> summary.md
        echo "--------------------------------------------------" >> summary.md
        jq -r '.results[] | "[\(.path):\(.start.line)] \(.extra.message) (\(.check_id))"' semgrep-error.json \
          | head -n 10 >> summary.md || echo "No findings" >> summary.md
        echo "" >> summary.md
      else
        SEMGREP_FAIL=0
        printf "%-10s | %-8s | %-25s | %-15s\n" "Semgrep" "âœ… OK" "0" "-" >> summary.md
      fi

    # ---- Trivy ----
    - |
      if [ -f trivy-report.json ]; then
        TRIVY_TOTAL=$(jq '[.Results[].Vulnerabilities? | length] | add' trivy-report.json 2>/dev/null || echo 0)
        if [ "$TRIVY_TOTAL" -gt 0 ]; then TRIVY_FAIL=1; else TRIVY_FAIL=0; fi
        printf "%-10s | %-8s | %s vulns | %s\n" \
          "Trivy" "$( [ $TRIVY_FAIL -eq 0 ] && echo 'âœ… OK' || echo 'âŒ FAIL')" "$TRIVY_TOTAL" "trivy-report.json" >> summary.md
        echo "--------------------------------------------------" >> summary.md
        echo "   ðŸ”Ž Trivy (first 10 vulnerabilities)" >> summary.md
        echo "--------------------------------------------------" >> summary.md
        jq -r '.Results[].Vulnerabilities[]? | "[\(.Severity)] \(.VulnerabilityID) - \(.PkgName) \(.InstalledVersion)"' trivy-report.json \
          | head -n 10 >> summary.md || echo "No vulnerabilities" >> summary.md
        echo "" >> summary.md
      else
        TRIVY_FAIL=0
        printf "%-10s | %-8s | %-25s | %-15s\n" "Trivy" "âœ… OK" "0" "-" >> summary.md
      fi

    # ---- PHPUnit ----
    - |
      if [ -f junit.xml ]; then
        PHPUNIT_TESTS=$(xmllint --xpath 'string(count(//testsuite/testcase))' junit.xml 2>/dev/null || echo 0)
        PHPUNIT_FAILURES=$(xmllint --xpath 'string(sum(//testsuite/@failures))' junit.xml 2>/dev/null || echo 0)
        PHPUNIT_ERRORS=$(xmllint --xpath 'string(sum(//testsuite/@errors))' junit.xml 2>/dev/null || echo 0)

        if [ "$PHPUNIT_TESTS" -gt 0 ] && [ "$PHPUNIT_FAILURES" -eq 0 ] && [ "$PHPUNIT_ERRORS" -eq 0 ]; then
          PHPUNIT_FAIL=0
        else
          PHPUNIT_FAIL=1;
        fi

        printf "%-10s | %-8s | %s tests, %s failures, %s errors | %s\n" \
          "PHPUnit" "$( [ $PHPUNIT_FAIL -eq 0 ] && echo 'âœ… OK' || echo 'âŒ FAIL')" "$PHPUNIT_TESTS" "$PHPUNIT_FAILURES" "$PHPUNIT_ERRORS" "junit.xml" >> summary.md
        echo "--------------------------------------------------" >> summary.md
        echo "   ðŸ”Ž PHPUnit (first 10 tests)" >> summary.md
        echo "--------------------------------------------------" >> summary.md
        xmllint --xpath '//testcase/@name' junit.xml 2>/dev/null \
          | sed -E 's/ name="/\n/g' | sed -E 's/"//g' | head -n 10 >> summary.md || echo "No tests" >> summary.md
        echo "" >> summary.md
      else
        PHPUNIT_FAIL=0
        printf "%-10s | %-8s | %-25s | %-15s\n" "PHPUnit" "âœ… OK" "0 tests" "-" >> summary.md
      fi

    # ---- Behat ----
    - |
      if [ -f behat-junit/default.xml ]; then
        BEHAT_TESTS=$(xmllint --xpath 'string(//testsuite/@tests)' behat-junit/default.xml 2>/dev/null || echo 0)
        BEHAT_FAILURES=$(xmllint --xpath 'string(//testsuite/@failures)' behat-junit/default.xml 2>/dev/null || echo 0)
        BEHAT_ERRORS=$(xmllint --xpath 'string(//testsuite/@errors)' behat-junit/default.xml 2>/dev/null || echo 0)
        BEHAT_SKIPPED=$(xmllint --xpath 'string(//testsuite/@skipped)' behat-junit/default.xml 2>/dev/null || echo 0)

        if [ "$BEHAT_TESTS" -gt 0 ] && [ "$BEHAT_FAILURES" -eq 0 ] && [ "$BEHAT_ERRORS" -eq 0 ]; then
          BEHAT_FAIL=0
        else
          BEHAT_FAIL=1
        fi

        printf "%-10s | %-8s | %s tests, %s failures, %s errors, %s skipped | %s\n" \
          "Behat" "$( [ $BEHAT_FAIL -eq 0 ] && echo 'âœ… OK' || echo 'âŒ FAIL')" \
          "$BEHAT_TESTS" "$BEHAT_FAILURES" "$BEHAT_ERRORS" "$BEHAT_SKIPPED" "behat-junit/default.xml" >> summary.md
        echo "--------------------------------------------------" >> summary.md
        echo "   ðŸ”Ž Behat (first 10 scenarios)" >> summary.md
        echo "--------------------------------------------------" >> summary.md
        xmllint --xpath '//testcase' behat-junit/default.xml 2>/dev/null \
          | grep -oP 'name="[^"]+"' \
          | sed -E 's/name="(.*)"/\1/' \
          | head -n 10 >> summary.md || echo "No scenarios" >> summary.md
        echo "" >> summary.md
      else
        BEHAT_FAIL=0
        printf "%-10s | %-8s | %-25s | %-15s\n" "Behat" "âœ… OK" "0 tests" "-" >> summary.md
      fi

    # ---- Final Verdict ----
    - echo "==================================================" >> summary.md
    - |
      if [ ${PHPCS_FAIL:-0} -ne 0 ] || [ ${SEMGREP_FAIL:-0} -ne 0 ] || [ ${TRIVY_FAIL:-0} -ne 0 ] || [ ${PHPUNIT_FAIL:-0} -ne 0 ] || [ ${BEHAT_FAIL:-0} -ne 0 ]; then
        echo "âŒ One or more critical scanners (PHPCS, Semgrep, Trivy, PHPUnit, Behat) reported issues." >> summary.md
        cat summary.md
        exit 1
      else
        cat summary.md
        echo "âœ… All critical scanners passed." >> summary.md
      fi

    - if [ ${PHPSTAN_WARN:-0} -ne 0 ]; then
        echo "âš ï¸ PHPStan findings are advisory only." >> summary.md;
      fi

  artifacts:
    when: always
    paths:
      - "$CI_PROJECT_DIR/summary.md"
      - "$CI_PROJECT_DIR/phpcs.xml"
      - "$CI_PROJECT_DIR/phpstan.json"
      - "$CI_PROJECT_DIR/semgrep-error.json"
      - "$CI_PROJECT_DIR/trivy-report.json"
      - "$CI_PROJECT_DIR/junit.xml"
      - "$CI_PROJECT_DIR/behat-junit/"
    expire_in: 1 week


